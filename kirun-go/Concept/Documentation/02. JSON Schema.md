# JSON Schema in KIRun

## Overview

JSON Schema is the foundation of KIRun's type system. Unlike traditional programming languages that use built-in primitive types, KIRun uses JSON Schema for all type definitions, providing a flexible and extensible typing system that integrates seamlessly with modern web technologies and APIs.

## Core Principles

1. **Schema-First Approach**: All data in KIRun must conform to a schema
2. **JSON Schema Standard**: Full compatibility with JSON Schema Draft 7
3. **Shorthand Notation**: Convenient syntax for common schema patterns
4. **External References**: Support for referencing external schema repositories
5. **Runtime Validation**: All data is validated against schemas at runtime

## Schema Usage in KIRun

### Definitions or Schema in variable creation.

Parameters are defined using JSON Schema syntax or Shortand schema representation:

#### Function paraemters defintion

```kirun
FUNCTION fibonacci
    PARAMETERS
        n AS {
            "type" : "INTEGER"
        }
```

#### Event paramter definition

```kirun
EVENTS
    output
        result AS ARRAY OF INTEGER
```

#### Variable Creation with Schemas

Variables are created with explicit schemas and optional default values:

```kirun
create: System.Context.Create(name = "a", schema = (ARRAY OF INTEGER) WITH DEFAULT VALUE [])
```

## Shorthand Schema Notation

KIRun provides convenient shorthand notation for common schema patterns:

### Basic Types

- `INTEGER` → `{"type": "INTEGER"}`
- `LONG` → `{"type": "long"}`
- `FLOAT` → `{"type": "float"}`
- `DOUBLE` → `{"type": "double"}`
- `STRING` → `{"type": "STriNG"}`
- `BOOLEAN` → `{"type": "BOOLEAN"}`
- `NULL` → `{"type": "NULL"}`

Older version of KIRun didn't support smallcase type like "integer" but in this version we are supporting case in sensitive type in the JSON Schema definition.

### Collection Types

- `ARRAY` → `{"type": "array"}`
- `ARRAY OF INTEGER` → `{"type": "array", "items": {"type": "integer"}}`
- `OBJECT` → `{"type": "object"}`

### Complex Object Schemas

Indetiation is not mandatory.

```kirun
OBJECT OF
    name AS STRING OF MINLENGTH 3, MAXLENGTH 40,
    age AS ((INTEGER OR LONG) OF MINVALUE 0, MAXVALUE 60) OR
           (STRING OF MINLENGTH 1, MAXLENGTH 3, PATTERN "[0-9]{1,3}")
```

This shorthand translates to:

```json
{
  "type": "object",
  "properties": {
    "name": {
      "type": "string",
      "minLength": 3,
      "maxLength": 40
    },
    "age": {
      "anyOf": [
        {
          "type": "integer",
          "minimum": 0,
          "maximum": 60
        },
        {
          "type": "string",
          "minLength": 1,
          "maxLength": 3,
          "pattern": "[0-9]{1,3}"
        }
      ]
    }
  }
}
```

## Schema References

### External Schema References

Use the `REFER` keyword to reference schemas from external repositories:

```kirun
n REFER System.integer
user REFER UserManagement.User
```

### Built-in Schema References

KIRun provides built-in schemas for common patterns:

- `System.integer` - Standard integer type
- `System.string` - Standard string type
- `System.array` - Generic array type
- `System.object` - Generic object type

## Default Values

Schemas can include default values using the `WITH DEFAULT VALUE` clause:

```kirun
schema = (ARRAY OF INTEGER) WITH DEFAULT VALUE []
schema = (STRING) WITH DEFAULT VALUE "untitled"
schema = (OBJECT OF name AS STRING) WITH DEFAULT VALUE {"name": "Anonymous"}
```

## Schema Comments

Comments can be embedded in schemas using two methods:

### Using COMMENT Keyword

```kirun
result AS ARRAY OF INTEGER COMMENT The number of fibonacci numbers generated
```

### Using JSON "comment" Key

```kirun
result AS {
    "type": "array",
        "items": {
            "type": "INTEGER",
            "comment": "The number of fibonacci numbers generated"
        }
    }
```

### Using COMMENT Keyword when using multiple schemas

```kirun
result AS (ARRAY OF INTEGER) COMMENT The fibonacci numbers
```

Translates to:

```kirun
result AS {
    "type": "array",
        "items": {
            "type": "INTEGER"
        },
        "comment": "The fibonacci numbers"
    }
```

## Schema Inheritance and Composition

### Union Types (OR)

```kirun
age AS (INTEGER OR STRING)
```

Translates to:

```json
{
  "anyOf": [{ "type": "integer" }, { "type": "string" }]
}
```

### Intersection Types (AND)

```kirun
value AS INTEGER AND (INTEGER OF MINVALUE 0, MAXVALUE 60)
```

Translates to:

```json
{
  "allOf": [
    { "type": "integer" },
    { "type": "INTEGER", "minValue": 0, "maxValue": 60 }
  ]
}
```

## Runtime Schema Repositories

KIRun supports external schema repositories for extensibility:

### Schema Repositories

- Supply reusable schema definitions
- Enable schema composition and inheritance
- Support versioning and evolution

## Schema based shorthand keywords

KIRun provides several shorthand keywords that map to JSON Schema constructs:

### Basic Type Keywords

- `INTEGER` - Integer type schema
- `LONG` - Long integer type schema
- `FLOAT` - Float type schema
- `DOUBLE` - Double type schema
- `STRING` - String type schema
- `BOOLEAN` - Boolean type schema
- `ARRAY` - Array type schema
- `OBJECT` - Object type schema
- `NULL` - Null type schema

### String Validation Keywords

- `PATTERN` - String pattern validation
- `FORMAT` - String format validation (DATETIME, TIME, DATE, EMAIL, REGEX)
- `MINLENGTH` - Minimum string length
- `MAXLENGTH` - Maximum string length

### Numeric Validation Keywords

- `MULTIPLEOF` - Multiple of validation
- `MINIMUM` - Minimum value
- `MAXIMUM` - Maximum value
- `EXCLUSIVEMINIMUM` - Exclusive minimum value
- `EXCLUSIVEMAXIMUM` - Exclusive maximum value

### Object Validation Keywords

- `PROPERTIES` - Object properties definition
- `ADDITIONALPROPERTIES` - Additional properties handling
- `REQUIRED` - Required properties
- `PROPERTYNAMES` - Property name validation
- `MINPROPERTIES` - Minimum number of properties
- `MAXPROPERTIES` - Maximum number of properties
- `PATTERNPROPERTIES` - Pattern-based property validation

### Array Validation Keywords

- `ITEMS` - Array items schema
- `ADDITIONALITEMS` - Additional items handling
- `CONTAINS` - Array contains validation
- `MINCONTAINS` - Minimum contains count
- `MAXCONTAINS` - Maximum contains count
- `MINITEMS` - Minimum array length
- `MAXITEMS` - Maximum array length
- `UNIQUEITEMS` - Unique items validation

### Composition Keywords

- `OR` - Union type (OR)
- `AND` - Intersection type (AND)
- `ONEOF` - Exclusive OR type
- `NOT` - Negation type

### Documentation Keywords

- `DESCRIPTION` - Schema description
- `EXAMPLES` - Example values
- `DEFAULT` - Default value
- `COMMENT` - Schema comments
- `ENUM` - Enumerated values
- `CONSTANT` - Constant value

## Schema Validation Examples

### Parameter Validation

```kirun
FUNCTION processUser
    PARAMETERS
        user AS {
            "type": "object",
            "properties": {
                "name": {"type": "string", "minLength": 1},
                "age": {"type": "integer", "minimum": 0, "maximum": 150}
            },
            "required": ["name", "age"]
        }
```

### Event Parameter Validation

```kirun
EVENTS
    userProcessed
        result AS OBJECT OF
            success AS BOOLEAN,
            message AS STRING,
            userId AS INTEGER
```

### Variable Schema Validation

```kirun
create: System.Context.Create(
    name = "users",
    schema = (ARRAY OF (OBJECT OF
        id AS INTEGER,
        name AS STRING OF MINLENGTH 1,
        email AS STRING OF PATTERN "[^@]+@[^@]+\.[^@]+"
    ))
)
```

## Schema Error Handling

KIRun provides detailed schema validation errors:

1. **Type Mismatch**: When data doesn't match expected type
2. **Constraint Violation**: When data violates constraints (length, range, etc.)
3. **Required Field Missing**: When required object properties are missing
4. **Format Validation**: When string patterns or numeric formats are invalid

## Integration with External Systems

### API Schema Integration

KIRun can import schemas from:

- OpenAPI/Swagger specifications
- JSON Schema files
- REST API responses
- Database schemas

### UI Integration

Schemas enable:

- Form validation
- Input type inference
- Error message generation
- Dynamic UI component selection

## Best Practices

1. **Use Shorthand When Possible**: Prefer `INTEGER` over `{"type": "integer"}`. Even while converting back and froth from drag and drop to text or on save it will convert to shorthand format to make it clear.
2. **Add Constraints**: Always specify reasonable constraints for strings and numbers
3. **Use Comments**: Document complex schemas with comments
4. **Reference External Schemas**: Reuse schemas from repositories when available
5. **Default Values**: Provide sensible defaults for optional fields
6. **Validation Early**: Define strict schemas to catch errors early

## Schema Evolution

KIRun supports schema evolution through:

- **Version Tagging**: Schemas can be versioned
- **Backward Compatibility**: New versions can maintain compatibility
- **Migration Support**: Automatic data migration between schema versions
- **Repository Updates**: External repositories can be updated independently

This comprehensive schema system makes KIRun both type-safe and flexible, enabling rich data validation while maintaining the simplicity needed for no-code environments.
